<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sudoku Master</title>
    <style>
        /* --- OFFLINE CSS SYSTEM (Replaces Tailwind) --- */
        :root {
            --bg-body: #f8fafc;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --white: #ffffff;
            --border: #e2e8f0;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #eab308;
            --cell-size: clamp(32px, 10vw, 48px);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            /* Mobile Viewport Height Fix */
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        
        /* Typography */
        .font-bold { font-weight: 700; }
        .font-mono { font-family: 'Courier New', Courier, monospace; }
        .text-center { text-align: center; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-3xl { font-size: 1.875rem; }
        .uppercase { text-transform: uppercase; }
        .tracking-wider { letter-spacing: 0.05em; }

        /* Layout & Spacing */
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .p-8 { padding: 2rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-6 { margin-bottom: 1.5rem; }

        /* Components */
        .btn {
            cursor: pointer;
            border: none;
            outline: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background-color: var(--primary); color: var(--white); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        
        .card {
            background: var(--white);
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--border);
            overflow: hidden;
            max-width: 28rem;
            margin: 0 auto;
        }

        .header {
            height: 3.5rem;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            flex-shrink: 0;
        }

        .status-bar {
            background: #f1f5f9;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }

        /* Grid */
        .sudoku-container {
            width: 100%;
            aspect-ratio: 1/1;
            background: #1e293b;
            padding: 4px;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .grid-9x9 {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            background: #cbd5e1;
            border: 2px solid #1e293b;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 100%;
            background-color: var(--white);
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            user-select: none;
            background: var(--white);
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            position: relative;
            color: var(--primary);
        }
        /* Thick Borders */
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(3n) { border-right: 2px solid #1e293b; }
        .cell:nth-child(9n) { border-right: none; } /* Reset for edge */
        
        .border-b-thick { border-bottom: 2px solid #1e293b !important; }
        .border-r-thick { border-right: 2px solid #1e293b !important; }
        
        /* Cell States */
        .cell.selected { background-color: #3b82f6; color: white; }
        .cell.related { background-color: #eff6ff; }
        .cell.same-val { background-color: #bfdbfe; }
        .cell.initial { font-weight: 800; color: #0f172a; background-color: #f1f5f9; }
        .cell.initial.selected { background-color: #3b82f6; color: white; }
        .cell.error { background-color: #fee2e2; color: #ef4444; }
        .cell.selected.error { background-color: #ef4444; color: white; }

        /* Hint Styles */
        .hint-target { animation: pulse-green 2s infinite; background-color: #f0fdf4 !important; }
        .hint-region { background-color: #fefce8 !important; } 
        .hint-blocker { background-color: #fef2f2 !important; color: #ef4444 !important; }
        
        .ghost-number {
            color: var(--success);
            opacity: 0.6;
            font-weight: bold;
            animation: bounce 0.5s;
        }

        /* Controls Grid */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.25rem;
            margin-bottom: 1rem;
        }
        .control-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.75rem;
            color: var(--text-muted);
            background: transparent;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            min-height: 3.5rem;
        }
        .control-btn:hover { background: var(--white); color: var(--primary); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .control-btn.active { background: var(--primary); color: var(--white); }
        .control-btn svg { width: 1.25rem; height: 1.25rem; margin-bottom: 0.25rem; }

        /* Numpad */
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 0.25rem;
        }
        .num-btn {
            aspect-ratio: 4/5;
            background: var(--white);
            border-radius: 0.75rem;
            border-bottom: 2px solid var(--border);
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .num-btn:active { transform: translateY(2px); border-bottom: none; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-green { 0%, 100% { box-shadow: inset 0 0 0 2px var(--success); } 50% { box-shadow: inset 0 0 0 4px var(--success); } }
        @keyframes bounce { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 24rem;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }

        /* Accessibility Focus */
        .cell:focus-visible, button:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: -2px;
            z-index: 20;
        }
    </style>
</head>
<body>

    <!-- ================= VIEW: MENU ================= -->
    <div id="menu-view" class="flex-1 flex flex-col items-center justify-center p-4 w-full relative fade-in">
        
        <!-- Language Switch -->
        <div class="absolute" style="top: 1rem; right: 1rem; z-index: 20; background: white; padding: 4px; border-radius: 999px; border: 1px solid var(--border);">
            <button onclick="setLanguage('tr')" id="lang-tr" class="btn text-xs font-bold px-4 py-1" style="border-radius: 999px;">TR</button>
            <button onclick="setLanguage('en')" id="lang-en" class="btn text-xs font-bold px-4 py-1" style="border-radius: 999px;">EN</button>
        </div>

        <div class="card w-full">
            <div class="p-8 text-center relative" style="background: var(--primary);">
                <div class="absolute" style="inset:0; background: #fff; opacity: 0.1; transform: skewY(-6deg) scale(1.5); transform-origin: top left;"></div>
                <h1 class="text-3xl font-bold" style="color: white; margin-bottom: 0.5rem; position: relative;">SUDOKU</h1>
                <p data-key="subtitle" class="text-sm font-medium" style="color: #c7d2fe; position: relative;">Meydan Oku</p>
                <div id="hint-msg-display" class="absolute bottom-1 left-0 right-0 text-xs font-bold" style="color: rgba(255,255,255,0.9); display:none;"></div>
            </div>
            
            <div class="p-8">
                <!-- Difficulty -->
                <div class="mb-6">
                    <label data-key="difficulty" class="text-xs font-bold uppercase tracking-wider flex items-center gap-2 mb-1" style="color: var(--text-muted);">
                        Zorluk
                    </label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;" id="difficulty-buttons"></div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col gap-2">
                     <!-- Continue Button (Hidden by default) -->
                     <button id="btn-continue" onclick="loadSavedGame()" class="hidden btn w-full p-4 font-bold mb-2" style="border-radius: 0.75rem; justify-content: center; gap: 0.5rem; background: var(--success); color: white;">
                        <svg style="width: 1.25rem; height: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path></svg>
                        <span data-key="continue">Devam Et</span>
                    </button>

                    <button id="btn-start" onclick="startGame(false)" class="btn btn-primary w-full p-4 font-bold" style="border-radius: 0.75rem; justify-content: flex-start; gap: 1rem;">
                        <div style="background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.5rem;">
                            <svg style="width: 1.25rem; height: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </div>
                        <div style="text-align: left;">
                            <div data-key="justPlay" class="text-sm" style="opacity: 0.8; font-weight: 400;">Yeni Oyun</div>
                            <div data-key="singlePlayer" class="text-lg" style="line-height: 1;">Tek Oyunculu</div>
                        </div>
                    </button>

                    <!-- Daily Challenge Button -->
                    <button id="btn-daily" onclick="startDailyChallenge()" class="btn w-full p-4 font-bold" style="border-radius: 0.75rem; justify-content: flex-start; gap: 1rem; background: #8b5cf6; color: white;">
                        <div style="background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.5rem;">
                            <svg style="width: 1.25rem; height: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <div style="text-align: left;">
                            <div data-key="dailyChallenge" class="text-lg" style="line-height: 1;">Günlük Meydan Okuma</div>
                            <div id="daily-date-display" class="text-xs" style="opacity: 0.8; font-weight: 400; margin-top:0.25rem;"></div>
                        </div>
                    </button>
                    
                    <!-- Loading State -->
                    <div id="loading-start" class="hidden w-full p-4 btn-primary font-bold flex items-center justify-center gap-2" style="border-radius: 0.75rem; background: #334155;">
                        <svg class="animate-spin" style="width: 1.25rem; height: 1.25rem;" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span data-key="generating">Oluşturuluyor...</span>
                    </div>

                    <div class="flex items-center py-3">
                        <div style="flex:1; height: 1px; background: var(--border);"></div>
                        <span data-key="competitive" class="px-4 text-xs font-bold uppercase" style="color: #cbd5e1;">Rekabetçi Mod</span>
                        <div style="flex:1; height: 1px; background: var(--border);"></div>
                    </div>

                    <!-- Code Section -->
                    <div class="p-4" style="background: #eef2ff; border-radius: 1rem; border: 1px solid #e0e7ff;">
                        <div class="flex items-center gap-2 mb-1">
                            <span data-key="gameCode" class="font-bold text-sm" style="color: var(--primary);">Oyun Kodu</span>
                        </div>
                        <p data-key="codeDesc" class="text-xs mb-2" style="color: #6366f1; opacity: 0.8;">Arkadaşınızla aynı tahtada oynamak için.</p>
                        
                        <div class="flex gap-2">
                            <div class="relative" style="flex: 1;">
                                <input id="game-code-input" type="text" aria-label="Game Code" placeholder="KOD" class="w-full p-2 font-mono font-bold text-center uppercase" style="border: 2px solid #c7d2fe; border-radius: 0.75rem; outline: none; color: var(--primary);" oninput="this.value = this.value.toUpperCase()">
                                <button onclick="generateRandomCode()" aria-label="Generate Random Code" class="absolute btn" style="right: 0.5rem; top: 50%; transform: translateY(-50%); color: #818cf8;">
                                    <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                </button>
                            </div>
                            <button onclick="startGame(true)" class="btn btn-primary font-bold px-4" style="border-radius: 0.75rem;">GO</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= VIEW: GAME ================= -->
    <div id="game-view" class="hidden h-full flex-col">
        
        <!-- Header -->
        <header class="header">
            <button onclick="showMenu()" class="btn" style="color: var(--text-muted);" aria-label="Back to Menu">
                <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            <h1 id="game-header-title" class="text-sm font-bold uppercase tracking-wider"></h1>
            <button onclick="togglePause()" class="btn" style="color: var(--text-muted);" aria-label="Pause Game">
                <svg id="pause-icon" style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
             <div class="flex items-center gap-2">
                 <span data-key="mistakes" class="text-xs font-bold uppercase" style="color: var(--text-muted);">Hatalar</span>
                 <div id="mistakes-container" class="font-mono font-bold text-sm px-2 py-1" style="background: white; border-radius: 4px; border: 1px solid var(--border);">
                     <span id="mistake-count">0</span>/3
                 </div>
             </div>
             <div class="flex items-center gap-2">
                 <span data-key="time" class="text-xs font-bold uppercase" style="color: var(--text-muted);">Süre</span>
                 <div class="font-mono font-bold text-sm px-3 py-1" style="background: var(--primary); color: white; border-radius: 4px;">
                     <span id="timer-display">00:00</span>
                 </div>
             </div>
        </div>

        <!-- Board Area -->
        <div class="flex-1 flex flex-col items-center justify-start p-4" style="overflow-y: auto;">
            <div id="board-container" class="sudoku-container" role="grid" aria-label="Sudoku Board">
                <div id="sudoku-grid" class="grid-9x9"></div>
            </div>

            <!-- Controls (5 Buttons Grid) -->
            <div class="w-full" style="max-width: 28rem;">
                <div class="controls-grid">
                     <button onclick="undo()" class="control-btn" aria-label="Undo">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                        <span data-key="undo">Geri</span>
                    </button>
                     <button onclick="resetGame()" class="control-btn" aria-label="Reset">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <span data-key="reset">Sıfırla</span>
                    </button>
                    <button id="btn-notes" onclick="toggleNotes()" class="control-btn" aria-label="Toggle Notes">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        <span data-key="notes">Notlar</span>
                    </button>
                    <button onclick="handleErase()" class="control-btn" style="color: var(--error);" aria-label="Erase Cell">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span data-key="erase">Sil</span>
                    </button>
                     <button id="btn-hint" onclick="findSmartHint()" class="control-btn" style="color: var(--warning);" aria-label="Use Hint">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        <span id="label-hint">İpucu (1)</span>
                    </button>
                </div>

                <div class="numpad-grid" id="numpad-container"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div id="modal-icon" style="width: 4rem; height: 4rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem auto;"></div>
            <h2 id="modal-title" class="text-3xl font-bold" style="color: var(--text-main); margin-bottom: 0.5rem;"></h2>
            <p id="modal-desc" class="text-sm" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>
            
            <div class="flex flex-col gap-2">
                <button id="modal-primary-btn" class="btn btn-primary p-4 font-bold w-full" style="border-radius: 0.75rem;"></button>
                <button onclick="showMenu()" data-key="mainMenu" class="btn p-3 font-bold w-full" style="background: white; border: 2px solid var(--border); border-radius: 0.75rem; color: var(--text-muted);">Menü</button>
            </div>
        </div>
    </div>

    <script>
        /* WORKER CODE AS STRING */
        const workerScript = `
            const BLANK = 0;
            function createSeededRandom(seedStr) {
                let h = 2166136261 >>> 0;
                for (let i = 0; i < seedStr.length; i++) h = Math.imul(h ^ seedStr.charCodeAt(i), 16777619);
                return function() {
                    let t = h += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1);
                    t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296;
                }
            }
            function isValid(bd, row, col, num) {
                for (let x = 0; x < 9; x++) if (bd[row][x] === num && x !== col) return false;
                for (let x = 0; x < 9; x++) if (bd[x][col] === num && x !== row) return false;
                const sr = 3 * Math.floor(row/3), sc = 3 * Math.floor(col/3);
                for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (bd[sr+i][sc+j] === num && (sr+i !== row || sc+j !== col)) return false;
                return true;
            }
            function solveSudoku(bd, rand) {
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (bd[r][c] === BLANK) {
                            const nums = [1,2,3,4,5,6,7,8,9].map(v => ({v, s: rand()})).sort((a,b)=>a.s-b.s).map(o=>o.v);
                            for (let n of nums) {
                                if (isValid(bd, r, c, n)) {
                                    bd[r][c] = n;
                                    if (solveSudoku(bd, rand)) return true;
                                    bd[r][c] = BLANK;
                                }
                            }
                            return false;
                        }
                    }
                }
                return true;
            }
            function countSolutions(bd, limit) {
                let count = 0;
                function solve(b) {
                    if (count >= limit) return;
                    let empty = null;
                    for(let r=0;r<9;r++){ for(let c=0;c<9;c++){ if(b[r][c]===BLANK){ empty=[r,c]; break;} } if(empty) break; }
                    if (!empty) { count++; return; }
                    const [r,c] = empty;
                    for(let n=1;n<=9;n++) {
                        if(isValid(b,r,c,n)) { b[r][c]=n; solve(b); b[r][c]=BLANK; if(count>=limit) return; }
                    }
                }
                solve(bd);
                return count;
            }
            function generatePuzzle(diff, seed) {
                const rng = seed ? createSeededRandom(seed) : Math.random;
                const sol = Array.from({length:9},()=>Array(9).fill(BLANK));
                solveSudoku(sol, rng);
                const puz = sol.map(r=>[...r]);
                let keep = 42;
                if(diff==='Medium') keep=35; if(diff==='Hard') keep=28; if(diff==='Extreme') keep=24;
                
                let pos=[]; for(let r=0;r<9;r++) for(let c=0;c<9;c++) pos.push([r,c]);
                for(let i=pos.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [pos[i],pos[j]]=[pos[j],pos[i]]; }
                
                let clues = 81;
                for(let [r,c] of pos) {
                    if(clues <= keep) break;
                    const val = puz[r][c]; puz[r][c]=BLANK;
                    const copy = puz.map(row=>[...row]);
                    if(countSolutions(copy, 2) !== 1) puz[r][c]=val;
                    else clues--;
                }
                return { puzzle: puz, solution: sol };
            }
            self.onmessage = e => { self.postMessage(generatePuzzle(e.data.difficulty, e.data.seedCode)); };
        `;

        // TRANSLATIONS
        const i18n = {
            en: {
                subtitle: "Challenge Yourself", difficulty: "Difficulty", singlePlayer: "Single Player", justPlay: "New Game", dailyChallenge: "Daily Challenge", competitive: "Or Play Competitive", gameCode: "Game Code", codeDesc: "Enter the same code to play on the same board.", enterCode: "CODE", mistakes: "Mistakes", time: "Time", undo: "Undo", reset: "Reset", notes: "Notes", erase: "Erase", hint: "Hint", solved: "SOLVED!", finalTime: "Time", mainMenu: "Main Menu", gameOver: "GAME OVER", tooManyMistakes: "Too many mistakes!", tryAgain: "Try Again", menu: "Menu", confirmReset: "Reset the board?", perfect: "Perfect so far!", boardFull: "No obvious moves found!", noHints: "No hints left!", generating: "Generating...", diffEasy: "Easy", diffMedium: "Medium", diffHard: "Hard", diffExtreme: "Extreme", continue: "Continue Game"
            },
            tr: {
                subtitle: "Meydan Oku", difficulty: "Zorluk", singlePlayer: "Tek Oyunculu", justPlay: "Yeni Oyun", dailyChallenge: "Günlük Meydan Okuma", competitive: "Rekabetçi Mod", gameCode: "Oyun Kodu", codeDesc: "Arkadaşınızla aynı tahtada oynamak için kod girin.", enterCode: "KOD", mistakes: "Hatalar", time: "Süre", undo: "Geri", reset: "Sıfırla", notes: "Notlar", erase: "Sil", hint: "İpucu", solved: "ÇÖZÜLDÜ!", finalTime: "Süre", mainMenu: "Ana Menü", gameOver: "OYUN BİTTİ", tooManyMistakes: "Çok fazla hata!", tryAgain: "Tekrar Dene", menu: "Menü", confirmReset: "Tahtayı sıfırlamak istiyor musun?", perfect: "Mükemmel!", boardFull: "Belirgin hamle bulunamadı!", noHints: "İpucu kalmadı!", generating: "Oluşturuluyor...", diffEasy: "Kolay", diffMedium: "Orta", diffHard: "Zor", diffExtreme: "Uzman", continue: "Devam Et"
            }
        };

        let currentLang = 'tr';
        const BLANK = 0;
        let board = [], initialBoard = [], solution = [], notes = {}, historyStack = [];
        let difficulty = 'Medium', currentCode = null, timer = 0, timerInterval = null;
        let isPaused = false, isGameComplete = false, selectedCell = null, notesMode = false;
        let mistakes = 0; const MAX_MISTAKES = 3;
        let hintsLeft = 1; let currentHintData = null;
        let lastInputTime = 0;

        // Validation Logic (needed on main thread for hints/input)
        function isValid(bd, r, c, n) {
            for(let x=0;x<9;x++) if(bd[r][x]===n && x!==c) return false;
            for(let x=0;x<9;x++) if(bd[x][c]===n && x!==r) return false;
            const sr=3*Math.floor(r/3), sc=3*Math.floor(c/3);
            for(let i=0;i<3;i++) for(let j=0;j<3;j++) if(bd[sr+i][sc+j]===n && (sr+i!==r || sc+j!==c)) return false;
            return true;
        }

        window.onload = function() {
            setLanguage('tr'); 
            renderDifficultyButtons(); 
            renderNumpad();
            checkSavedGame();
            
            // Set Daily Date
            const today = new Date();
            document.getElementById('daily-date-display').innerText = today.toLocaleDateString();
        };

        function setLanguage(lang) {
            currentLang = lang;
            const t = i18n[lang];
            const btnTr = document.getElementById('lang-tr');
            const btnEn = document.getElementById('lang-en');
            
            if (lang === 'tr') {
                btnTr.style.background = 'var(--primary)'; btnTr.style.color = 'white';
                btnEn.style.background = 'transparent'; btnEn.style.color = 'var(--text-muted)';
            } else {
                btnEn.style.background = 'var(--primary)'; btnEn.style.color = 'white';
                btnTr.style.background = 'transparent'; btnTr.style.color = 'var(--text-muted)';
            }

            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (t[key]) el.innerHTML = t[key];
            });
            document.getElementById('game-code-input').placeholder = t.enterCode;
            renderDifficultyButtons(); updateHintButton();
        }

        function getText(key) { return i18n[currentLang][key] || key; }

        function renderDifficultyButtons() {
            const container = document.getElementById('difficulty-buttons');
            const levels = ['Easy', 'Medium', 'Hard', 'Extreme'];
            const labels = { 'Easy': getText('diffEasy'), 'Medium': getText('diffMedium'), 'Hard': getText('diffHard'), 'Extreme': getText('diffExtreme') };
            container.innerHTML = levels.map(d => `
                <button onclick="setDifficulty('${d}')" class="btn ${difficulty === d ? 'btn-primary' : ''}" style="padding: 0.5rem; font-size: 0.75rem; font-weight: bold; border-radius: 0.5rem; background: ${difficulty === d ? 'var(--primary)' : '#f1f5f9'}; color: ${difficulty === d ? '#fff' : '#64748b'};">${labels[d]}</button>
            `).join('');
        }

        function renderNumpad() {
            document.getElementById('numpad-container').innerHTML = [1,2,3,4,5,6,7,8,9].map(i => `
                <button onclick="handleInput(${i})" class="btn num-btn" aria-label="Enter number ${i}">${i}</button>
            `).join('');
        }

        function setDifficulty(d) { difficulty = d; renderDifficultyButtons(); }
        
        function generateRandomCode() {
            const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let r = ''; for(let i=0;i<5;i++) r += c.charAt(Math.floor(Math.random()*c.length));
            document.getElementById('game-code-input').value = r;
        }

        /* --- PERSISTENCE --- */
        const SAVE_KEY = 'sudoku_master_save_v1';

        function saveStateToStorage() {
            if(isGameComplete) { localStorage.removeItem(SAVE_KEY); return; }
            const state = {
                board, initialBoard, solution, notes, mistakes,
                difficulty, currentCode, timer, historyStack, hintsLeft
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }

        function checkSavedGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if(saved) {
                document.getElementById('btn-continue').classList.remove('hidden');
                document.getElementById('btn-continue').classList.add('flex');
            }
        }

        function loadSavedGame() {
            try {
                const saved = JSON.parse(localStorage.getItem(SAVE_KEY));
                if(!saved) return;
                
                board = saved.board; initialBoard = saved.initialBoard; solution = saved.solution;
                notes = saved.notes || {}; mistakes = saved.mistakes || 0;
                difficulty = saved.difficulty; currentCode = saved.currentCode;
                timer = saved.timer || 0; historyStack = saved.historyStack || [];
                hintsLeft = saved.hintsLeft;

                // Resume Game UI
                isPaused = false; isGameComplete = false; selectedCell = null; currentHintData = null;
                document.getElementById('menu-view').classList.add('hidden');
                document.getElementById('game-view').classList.remove('hidden');
                document.getElementById('game-view').classList.add('flex');
                
                let t = difficulty;
                if(t==='Easy') t=getText('diffEasy'); if(t==='Medium') t=getText('diffMedium'); 
                if(t==='Hard') t=getText('diffHard'); if(t==='Extreme') t=getText('diffExtreme');
                document.getElementById('game-header-title').innerText = currentCode ? `#${currentCode}` : t;
                
                updateUI();
                renderBoard();
                startTimer();
            } catch(e) { console.error("Save file corrupt", e); localStorage.removeItem(SAVE_KEY); }
        }

        function startDailyChallenge() {
            // Generate DAILY-YYYYMMDD code
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dailyCode = `DAILY-${yyyy}${mm}${dd}`;

            document.getElementById('game-code-input').value = dailyCode;
            
            // Set Difficulty to Hard specifically for daily challenge to keep it consistent
            setDifficulty('Hard');

            startGame(true);
        }

        function startGame(useCode) {
            document.getElementById('btn-start').classList.add('hidden');
            document.getElementById('btn-daily').classList.add('hidden'); // Hide daily button too
            document.getElementById('btn-continue').classList.add('hidden');
            document.getElementById('loading-start').classList.remove('hidden');
            document.getElementById('loading-start').style.display = 'flex';

            const inputVal = document.getElementById('game-code-input').value.toUpperCase();
            currentCode = useCode ? (inputVal || (generateRandomCode(), document.getElementById('game-code-input').value)) : null;

            const blob = new Blob([workerScript], { type: 'application/javascript' });
            const worker = new Worker(URL.createObjectURL(blob));

            worker.onmessage = function(e) {
                const data = e.data;
                initialBoard = data.puzzle.map(r => [...r]);
                board = data.puzzle.map(r => [...r]);
                solution = data.solution;
                
                timer = 0; isPaused = false; isGameComplete = false; selectedCell = null; currentHintData = null;
                notes = {}; notesMode = false; mistakes = 0; historyStack = []; hintsLeft = 1;
                
                saveStateToStorage(); // Save initial state
                updateUI();
                
                document.getElementById('btn-start').classList.remove('hidden');
                document.getElementById('btn-daily').classList.remove('hidden');
                document.getElementById('loading-start').classList.add('hidden');
                document.getElementById('loading-start').style.display = 'none';
                document.getElementById('menu-view').classList.add('hidden');
                document.getElementById('game-view').classList.remove('hidden');
                document.getElementById('game-view').classList.add('flex');
                document.getElementById('modal-overlay').classList.add('hidden');
                
                let t = difficulty;
                if(t==='Easy') t=getText('diffEasy'); if(t==='Medium') t=getText('diffMedium'); 
                if(t==='Hard') t=getText('diffHard'); if(t==='Extreme') t=getText('diffExtreme');
                document.getElementById('game-header-title').innerText = currentCode ? `#${currentCode}` : t;

                renderBoard();
                startTimer();
                worker.terminate();
            };
            worker.postMessage({ difficulty, seedCode: currentCode });
        }

        function updateUI() {
            const noteBtn = document.getElementById('btn-notes');
            if(notesMode) { noteBtn.classList.add('active'); } else { noteBtn.classList.remove('active'); }
            
            const mContainer = document.getElementById('mistakes-container');
            document.getElementById('mistake-count').innerText = mistakes;
            if(mistakes>0) { mContainer.style.background='#fef2f2'; mContainer.style.color='var(--error)'; mContainer.style.borderColor='var(--error)'; }
            else { mContainer.style.background='white'; mContainer.style.color='black'; mContainer.style.borderColor='var(--border)'; }
            
            updateHintButton();
        }

        function updateHintButton() {
            const btn = document.getElementById('btn-hint');
            const lbl = document.getElementById('label-hint');
            lbl.innerText = `${getText('hint')} (${hintsLeft})`;
            btn.disabled = hintsLeft <= 0;
            btn.style.opacity = hintsLeft <= 0 ? '0.5' : '1';
        }

        function restartSameLevel() { startGame(!!currentCode); }
        function showMenu() {
            stopTimer();
            saveStateToStorage();
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('flex');
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('modal-overlay').classList.add('hidden');
            checkSavedGame();
        }

        function startTimer() { stopTimer(); timerInterval = setInterval(() => { timer++; const m=Math.floor(timer/60),s=timer%60; document.getElementById('timer-display').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }, 1000); }
        function stopTimer() { if (timerInterval) clearInterval(timerInterval); }
        function togglePause() { isPaused = !isPaused; renderBoard(); if(isPaused) stopTimer(); else startTimer(); }

        function toggleNotes() { notesMode = !notesMode; updateUI(); }
        function saveState() { if(historyStack.length>30) historyStack.shift(); historyStack.push({b:JSON.parse(JSON.stringify(board)),n:JSON.parse(JSON.stringify(notes)),m:mistakes}); }
        function undo() {
            if(!historyStack.length || isGameComplete || isPaused) return;
            const s = historyStack.pop(); board = s.b; notes = s.n; currentHintData = null; renderBoard(); saveStateToStorage();
        }
        function resetGame() { if(confirm(getText('confirmReset'))) { saveState(); board=initialBoard.map(r=>[...r]); notes={}; currentHintData=null; hintsLeft=1; updateUI(); renderBoard(); saveStateToStorage(); } }

        /* --- ADVANCED SOLVING LOGIC (Singles + Locked Candidates) --- */
        function getStrictCandidates(r, c, currentBoard) {
            let cands = [];
            if(currentBoard[r][c] !== BLANK) return [];
            for(let n=1;n<=9;n++) {
                if(isValid(currentBoard, r, c, n)) cands.push(n);
            }
            return cands;
        }

        // Returns a full map of candidates for the board
        function getAllCandidatesMap(bd) {
            let map = Array.from({length:9}, () => Array(9).fill(null));
            for(let r=0; r<9; r++) {
                for(let c=0; c<9; c++) {
                    if(bd[r][c] === BLANK) map[r][c] = getStrictCandidates(r, c, bd);
                }
            }
            return map;
        }

        function findSmartHint() {
            if(isGameComplete || isPaused || hintsLeft<=0) return;
            currentHintData = null;

            // Step 1: Initialize full candidate map
            let candMap = getAllCandidatesMap(board);

            // Step 2: Apply Locked Candidates (Pointing & Claiming) iteratively to reduce candidates
            // We run this loop to "clean" the notes internally before checking for singles.
            // This simulates an advanced player's pencil marks.
            let changed = true;
            while(changed) {
                changed = false;
                // Check Blocks for Pointing Pairs (Type 1)
                for(let b=0; b<9; b++) {
                    const sr=Math.floor(b/3)*3, sc=(b%3)*3;
                    let numPositions = {}; // num -> array of [r,c]
                    for(let i=0; i<3; i++) for(let j=0; j<3; j++) {
                        const r=sr+i, c=sc+j;
                        if(candMap[r][c]) {
                            candMap[r][c].forEach(n => {
                                if(!numPositions[n]) numPositions[n] = [];
                                numPositions[n].push([r,c]);
                            });
                        }
                    }
                    for(let n in numPositions) {
                        const pos = numPositions[n];
                        if(pos.length < 2) continue;
                        
                        // Check if all in same Row
                        const sameRow = pos.every(p => p[0] === pos[0][0]);
                        if(sameRow) {
                            const r = pos[0][0];
                            for(let c=0; c<9; c++) {
                                // If column is NOT in this block, remove candidate
                                if(Math.floor(c/3) !== (b%3) && candMap[r][c] && candMap[r][c].includes(parseInt(n))) {
                                    candMap[r][c] = candMap[r][c].filter(x => x !== parseInt(n));
                                    changed = true;
                                }
                            }
                        }

                        // Check if all in same Col
                        const sameCol = pos.every(p => p[1] === pos[0][1]);
                        if(sameCol) {
                            const c = pos[0][1];
                            for(let r=0; r<9; r++) {
                                if(Math.floor(r/3) !== Math.floor(b/3) && candMap[r][c] && candMap[r][c].includes(parseInt(n))) {
                                    candMap[r][c] = candMap[r][c].filter(x => x !== parseInt(n));
                                    changed = true;
                                }
                            }
                        }
                    }
                }
                // (Could add Claiming Pairs here too, but Pointing is usually enough for 'Extreme' progress)
            }

            // Step 3: Find Naked Singles in the reduced map
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) {
                if(candMap[r][c] && candMap[r][c].length === 1) {
                    applyHint(r, c, candMap[r][c][0], 'naked');
                    return;
                }
            }

            // Step 4: Find Hidden Singles in the reduced map
            // Rows
            for(let r=0;r<9;r++) {
                let counts = {};
                for(let c=0;c<9;c++) if(candMap[r][c]) candMap[r][c].forEach(n => { if(!counts[n]) counts[n]=[]; counts[n].push([r,c]); });
                for(let n in counts) if(counts[n].length===1) { applyHint(counts[n][0][0], counts[n][0][1], parseInt(n), 'hidden-row'); return; }
            }
            // Cols
            for(let c=0;c<9;c++) {
                let counts = {};
                for(let r=0;r<9;r++) if(candMap[r][c]) candMap[r][c].forEach(n => { if(!counts[n]) counts[n]=[]; counts[n].push([r,c]); });
                for(let n in counts) if(counts[n].length===1) { applyHint(counts[n][0][0], counts[n][0][1], parseInt(n), 'hidden-col'); return; }
            }
            // Boxes
            for(let b=0;b<9;b++) {
                let counts = {};
                const sr=Math.floor(b/3)*3, sc=(b%3)*3;
                for(let i=0;i<3;i++) for(let j=0;j<3;j++) {
                    const r=sr+i, c=sc+j;
                    if(candMap[r][c]) candMap[r][c].forEach(n => { if(!counts[n]) counts[n]=[]; counts[n].push([r,c]); });
                }
                for(let n in counts) if(counts[n].length===1) { applyHint(counts[n][0][0], counts[n][0][1], parseInt(n), 'hidden-box'); return; }
            }

            alert(getText('boardFull'));
        }

        function applyHint(r, c, val, type) {
            currentHintData = { target: [r,c], value: val, type: type, region: [] };
            
            // Visuals
            if(type === 'hidden-row') for(let i=0;i<9;i++) currentHintData.region.push([r,i]);
            else if(type === 'hidden-col') for(let i=0;i<9;i++) currentHintData.region.push([i,c]);
            else if(type === 'hidden-box') {
                const sr=Math.floor(r/3)*3, sc=Math.floor(c/3)*3;
                for(let i=0;i<3;i++) for(let j=0;j<3;j++) currentHintData.region.push([sr+i, sc+j]);
            }

            selectedCell = [r, c];
            hintsLeft--;
            updateHintButton();
            renderBoard();
            saveStateToStorage();
        }

        function checkBoard() {
            let err = 0;
            for(let r=0;r<9;r++) for(let c=0;c<9;c++) if(board[r][c]!==BLANK && board[r][c]!==solution[r][c]) err++;
            if(err===0) alert(getText('perfect')); else alert(err + (currentLang==='tr'?' hata':' mistakes'));
        }

        function showModal(type) {
            const over = document.getElementById('modal-overlay');
            const icon = document.getElementById('modal-icon');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const btn = document.getElementById('modal-primary-btn');
            
            over.classList.remove('hidden');
            if(type === 'win') {
                localStorage.removeItem(SAVE_KEY); // Clear save on win
                icon.style.background = '#fef9c3'; icon.innerHTML = '<svg style="width:2rem;height:2rem;color:#ca8a04;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                title.innerText = getText('solved');
                desc.innerText = `${getText('finalTime')}: ${document.getElementById('timer-display').innerText}`;
                btn.innerText = getText('mainMenu');
                btn.onclick = showMenu;
            } else {
                localStorage.removeItem(SAVE_KEY); // Clear save on lose
                icon.style.background = '#fee2e2'; icon.innerHTML = '<svg style="width:2rem;height:2rem;color:#ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                title.innerText = getText('gameOver');
                desc.innerText = getText('tooManyMistakes');
                btn.innerText = getText('tryAgain');
                btn.onclick = restartSameLevel;
            }
        }

        function renderBoard() {
            const grid = document.getElementById('sudoku-grid');
            grid.innerHTML = '';
            
            if(isPaused) {
                grid.innerHTML = '<div style="grid-column:1/-1;grid-row:1/-1;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#64748b;">PAUSED</div>';
                return;
            }

            for(let r=0;r<9;r++) for(let c=0;c<9;c++) {
                const val = board[r][c];
                const init = initialBoard[r][c]!==BLANK;
                const sel = selectedCell && selectedCell[0]===r && selectedCell[1]===c;
                const err = val!==BLANK && !init && val!==solution[r][c];
                
                const isHintTarget = currentHintData && currentHintData.target[0]===r && currentHintData.target[1]===c;
                const isHintRegion = currentHintData && currentHintData.region.some(p => p[0]===r && p[1]===c);

                const el = document.createElement('div');
                el.className = 'cell';
                el.role = 'gridcell';
                el.tabIndex = 0;
                // Accessibility Label
                const posLabel = `Row ${r+1} Col ${c+1}`;
                const valLabel = val === BLANK ? "Empty" : val;
                el.setAttribute('aria-label', `${posLabel}, ${valLabel}`);

                // Styles
                if(c%3===2 && c!==8) el.classList.add('border-r-thick');
                if(r%3===2 && r!==8) el.classList.add('border-b-thick');
                
                if(sel) { el.classList.add('selected'); if(err) el.classList.add('error'); }
                else if(selectedCell) {
                    const [sr, sc] = selectedCell;
                    if(board[sr][sc]!==BLANK && val===board[sr][sc]) el.classList.add('same-val');
                    else if(sr===r || sc===c || (Math.floor(sr/3)===Math.floor(r/3) && Math.floor(sc/3)===Math.floor(c/3))) el.classList.add('related');
                }

                if(init) { el.classList.add('initial'); if(sel) el.classList.add('selected'); }
                else if(err && !sel) el.classList.add('error');

                if(isHintTarget) el.classList.add('hint-target');
                if(isHintRegion && !isHintTarget) el.classList.add('hint-region');

                // Content
                if(val!==BLANK) el.innerText = val;
                else if(isHintTarget) el.innerHTML = `<span class="ghost-number">${currentHintData.value}</span>`;
                else {
                    const n = notes[`${r}-${c}`];
                    if(n && n.length) {
                        el.style.display = 'grid'; el.style.gridTemplateColumns='repeat(3,1fr)'; el.style.fontSize='0.5rem'; el.style.lineHeight='1';
                        for(let k=1;k<=9;k++) {
                            const s = document.createElement('span');
                            s.style.display='flex'; s.style.justifyContent='center'; s.style.alignItems='center';
                            s.innerText = n.includes(k) ? k : '';
                            s.style.color = '#64748b';
                            el.appendChild(s);
                        }
                    }
                }

                el.onclick = () => { if(!isGameComplete) { selectedCell=[r,c]; currentHintData=null; renderBoard(); } };
                // Keyboard Nav focus update
                el.onfocus = () => { if(!isGameComplete) { selectedCell=[r,c]; renderBoard(); } };
                
                grid.appendChild(el);
            }
        }

        function handleInput(n) {
            // Debounce to prevent bounce/double triggers on mobile
            const now = Date.now();
            if (now - lastInputTime < 150) return; // 150ms lockout
            lastInputTime = now;

            if(!selectedCell || isGameComplete || isPaused) return;
            const [r,c] = selectedCell;
            if(initialBoard[r][c]!==BLANK) return;
            if(board[r][c]===solution[r][c]) return;

            if(notesMode) {
                const k = `${r}-${c}`;
                if(!notes[k]) notes[k]=[];
                if(notes[k].includes(n)) notes[k]=notes[k].filter(x=>x!==n); else notes[k].push(n);
                saveStateToStorage();
            } else {
                saveState();
                if(n!==solution[r][c]) {
                    mistakes++; board[r][c]=n; updateUI(); renderBoard(); saveStateToStorage();
                    if(mistakes>=MAX_MISTAKES) { isGameComplete=true; stopTimer(); showModal('lose'); }
                } else {
                    board[r][c]=n; 
                    // Clear notes in row/col/box
                    const sr=Math.floor(r/3)*3, sc=Math.floor(c/3)*3;
                    for(let i=0;i<9;i++) {
                        if(notes[`${r}-${i}`]) notes[`${r}-${i}`]=notes[`${r}-${i}`].filter(x=>x!==n);
                        if(notes[`${i}-${c}`]) notes[`${i}-${c}`]=notes[`${i}-${c}`].filter(x=>x!==n);
                    }
                    for(let i=0;i<3;i++) for(let j=0;j<3;j++) {
                        const k=`${sr+i}-${sc+j}`; if(notes[k]) notes[k]=notes[k].filter(x=>x!==n);
                    }
                    
                    let filled=0; for(let i=0;i<9;i++) for(let j=0;j<9;j++) if(board[i][j]!==BLANK) filled++;
                    saveStateToStorage();
                    if(filled===81) { isGameComplete=true; stopTimer(); showModal('win'); }
                }
            }
            currentHintData=null;
            renderBoard();
        }

        function handleErase() {
            // Debounce
            const now = Date.now();
            if (now - lastInputTime < 150) return;
            lastInputTime = now;

            if(!selectedCell || isGameComplete || isPaused) return;
            const [r,c] = selectedCell;
            if(initialBoard[r][c]!==BLANK) return;
            saveState();
            board[r][c]=BLANK; notes[`${r}-${c}`]=[]; currentHintData=null; renderBoard();
            saveStateToStorage();
        }

        document.addEventListener('keydown', e => {
            if(!selectedCell || isGameComplete || isPaused) return;
            const k = e.key;
            if(k>='1' && k<='9') {
                e.preventDefault(); 
                if (document.activeElement) document.activeElement.blur(); 
                handleInput(parseInt(k));
            }
            if(k==='Backspace'||k==='Delete') handleErase();
            if(k==='n'||k==='N') toggleNotes();
            if(k==='h'||k==='H') findSmartHint();
            if((e.ctrlKey||e.metaKey) && k==='z') undo();
            
            let [r,c] = selectedCell;
            if(k==='ArrowUp') r=Math.max(0,r-1); if(k==='ArrowDown') r=Math.min(8,r+1);
            if(k==='ArrowLeft') c=Math.max(0,c-1); if(k==='ArrowRight') c=Math.min(8,c+1);
            if(r!==selectedCell[0]||c!==selectedCell[1]) {
                selectedCell=[r,c]; renderBoard();
                // Move focus for screen reader
                const idx = r*9+c;
                const cells = document.querySelectorAll('.cell');
                if(cells[idx]) cells[idx].focus(); 
            }
        });
    </script>
</body>
</html>
